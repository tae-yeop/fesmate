# 2026-01-03 기타 기능 (~21개) 테스트 가이드

> **Plan 파일**: `C:\Users\tyk\.claude\plans\fizzy-dreaming-sonnet.md`
> **완료 상태**: 21/21 (카카오 OAuth 제외 - 사업자 인증 필요)

---

## 목차

1. [P0 - 즉시 구현 (1-5)](#p0---즉시-구현)
2. [P1 - 알림 시스템 고도화 (6-9)](#p1---알림-시스템-고도화)
3. [P2 - 푸시 알림 PWA (10-13)](#p2---푸시-알림-pwa)
4. [P2 - 콜가이드 고도화 (14-16)](#p2---콜가이드-고도화)
5. [P2 - 리더보드 고도화 (17-19)](#p2---리더보드-고도화)
6. [P3 - 기타 (20-21)](#p3---기타)

---

## P0 - 즉시 구현

### 1. 자기 글 도움됨 차단

**파일**: `src/lib/helpful-context.tsx`

**테스트 방법**:
1. `npm run dev`로 개발 서버 실행
2. Dev 메뉴(🛠️)에서 사용자를 `user1`로 설정
3. `/community` 접속
4. `user1`이 작성한 글 찾기 (또는 새 글 작성)
5. 해당 글의 "도움됨" 버튼 클릭
6. **예상 결과**: 버튼이 비활성화되거나 클릭해도 카운트 변화 없음
7. 다른 사용자(`user2`)의 글에서는 도움됨 토글 정상 동작 확인

**검증 포인트**:
- 자신의 글에는 도움됨 불가
- 콘솔에 `[HelpfulContext] Cannot mark own post as helpful` 로그 출력

---

### 2. canViewContent 완성 (friends/crew 레벨)

**파일**: `src/lib/user-profile-context.tsx`

**테스트 방법**:
1. Dev 메뉴에서 `user1`로 로그인
2. `/user/user3` (다른 사용자 프로필) 접속
3. 프로필 설정에서 `show_activity: "friends"` 인 사용자 확인
4. **맞팔 아닌 경우**: 활동 내역이 숨겨져야 함
5. Dev 메뉴에서 `user1` → `user3` 맞팔 설정
6. **맞팔인 경우**: 활동 내역 표시됨

**검증 포인트**:
- `public`: 누구나 볼 수 있음
- `friends`: 맞팔(mutual follow)만 볼 수 있음
- `crew`: 같은 크루 멤버만 볼 수 있음
- `private`: 본인만 볼 수 있음

---

### 3. 리더보드 신고 시 점수 차감

**파일**: `src/lib/leaderboard-context.tsx`

**테스트 방법**:
1. `/leaderboard` 접속
2. 특정 사용자의 현재 점수 확인 (예: 1200점)
3. 해당 사용자의 글/댓글 신고
4. 리더보드 새로고침
5. **예상 결과**: 점수 50점 차감 (1150점)

**검증 포인트**:
- `REPORT_PENALTY = 50` 적용 확인
- 신고당한 사용자의 점수만 차감
- 신고한 사용자는 영향 없음

---

### 4. 신고 누적 시 글 자동 숨김

**파일**: `src/lib/post-context.tsx`

**테스트 방법**:
1. `/community`에서 테스트용 글 확인
2. Dev 메뉴로 3명의 다른 사용자(`user1`, `user2`, `user3`)로 전환하며 동일 글 신고
3. 3번째 신고 후 글 목록 새로고침
4. **예상 결과**: 해당 글이 숨김 처리됨

**검증 포인트**:
- `HIDE_THRESHOLD = 3` (3회 신고 시 숨김)
- `isHiddenByReports(postId)` 함수로 확인 가능
- 숨겨진 글은 기본 목록에서 제외

---

### 5. 숨김 글 UI - 검토 중 표시 + 보기/차단 CTA

**파일**: `src/components/posts/PostCard.tsx`

**테스트 방법**:
1. 위 테스트에서 숨김 처리된 글이 있는 상태에서
2. `/community` 접속
3. 숨김 글 위치에 다음 UI 표시 확인:
   - 노란색/빨간색 배경의 "검토 중" 배너
   - "이 글은 신고 검토 중입니다" 메시지
   - "그래도 보기" 버튼
   - "작성자 차단" 버튼
4. "그래도 보기" 클릭 → 글 내용 표시
5. "작성자 차단" 클릭 → 차단 처리

**검증 포인트**:
- `HiddenPostCard` 컴포넌트 렌더링
- 경고 아이콘 + 신고 횟수 표시
- CTA 버튼 동작

---

## P1 - 알림 시스템 고도화

### 6. Quiet Hours (22:00-08:00) 알림 제한

**파일**: `src/lib/notification-context.tsx`

**테스트 방법**:
1. Dev 메뉴에서 시간을 **22:30**으로 설정
2. 알림을 트리거하는 행동 수행 (글 작성, 댓글 등)
3. `/notifications` 확인
4. **예상 결과**: 알림이 Quiet Hours로 인해 지연됨
5. 시간을 **08:30**으로 변경 후 알림 확인
6. **예상 결과**: 지연된 알림이 배달됨

**검증 포인트**:
- 22:00~08:00 사이 알림 생성 시 `quietHoursDeferred: true`
- 콘솔에 `[NotificationContext] Quiet hours active` 로그
- 지연된 알림은 08:00 이후 순차 배달

---

### 7. 중복 묶음 (dedupe_key) 알림 처리

**파일**: `src/lib/notification-context.tsx`

**테스트 방법**:
1. 짧은 시간 내에 동일 유형의 알림 여러 개 생성
   - 예: 같은 글에 댓글 3개 연속 작성
2. `/notifications` 확인
3. **예상 결과**: "외 2명이 댓글을 남겼습니다" 형태로 묶임

**검증 포인트**:
- `dedupe_key` 기준으로 5분 내 알림 병합
- `groupedCount` 필드에 묶인 개수 표시
- 펼치면 개별 알림 확인 가능

---

### 8. 콜가이드 LIVE 연동 (HubTab)

**파일**: `src/app/event/[id]/components/HubTab.tsx`

**테스트 방법**:
1. `/event/e2` (LIVE 모드 행사) 접속
2. "허브" 탭 선택
3. **예상 결과**: 콜가이드 바로가기 버튼/섹션 표시
4. 버튼 클릭 → `/call-guide/{songId}` 또는 `/fieldnote/call/{songId}` 이동

**검증 포인트**:
- LIVE 모드에서만 콜가이드 링크 표시
- 해당 행사의 아티스트 곡 목록 연결
- RECAP 모드에서는 다른 UI 또는 숨김

---

### 9. 슬롯 시작 10분 전 알림

**파일**: `src/lib/my-timetable-context.tsx`

**테스트 방법**:
1. `/myfes` → 타임테이블에서 슬롯 추가
2. Dev 메뉴에서 시간을 슬롯 시작 **15분 전**으로 설정
3. 5분 대기 또는 시간을 **10분 전**으로 변경
4. `/notifications` 확인
5. **예상 결과**: "🎵 [아티스트명] 공연이 10분 후 시작됩니다!" 알림

**검증 포인트**:
- `SLOT_REMINDER_MINUTES = 10` 설정
- 알림 클릭 시 해당 슬롯 상세로 이동
- 이미 알림 보낸 슬롯은 중복 발송 안 함

---

## P2 - 푸시 알림 PWA

### 10. PWA Service Worker 설정

**파일**: `public/sw.js`, `src/lib/service-worker.ts`

**테스트 방법**:
1. `npm run build && npm start` (프로덕션 모드)
2. Chrome DevTools → Application → Service Workers
3. **예상 결과**: `sw.js` 등록 및 활성화 상태
4. 오프라인 모드 테스트: 네트워크 끊고 새로고침
5. **예상 결과**: 캐시된 페이지 표시

**검증 포인트**:
- Service Worker 상태: `activated and running`
- Cache Storage에 정적 자산 저장됨
- `manifest.json` 연결 확인

---

### 11. Web Push API 통합

**파일**: `src/lib/notification-context.tsx`, `src/lib/push-notification.ts`

**테스트 방법**:
1. Chrome에서 알림 권한 허용
2. `Notification.permission` === `"granted"` 확인
3. 푸시 알림 트리거 (예: 슬롯 알림)
4. **예상 결과**: 브라우저 푸시 알림 표시

**검증 포인트**:
- `PushManager.subscribe()` 성공
- 푸시 알림에 앱 아이콘 표시
- 알림 클릭 시 앱으로 포커스 이동

---

### 12. 알림 권한 요청 UI

**파일**: `src/components/notifications/NotificationPermission.tsx`

**테스트 방법**:
1. 브라우저 알림 권한을 "기본값"으로 초기화
2. 앱 접속 시 또는 특정 화면에서 권한 요청 모달 표시
3. **예상 결과**:
   - "알림을 허용하시겠습니까?" 모달
   - "허용" / "나중에" 버튼
4. "허용" 클릭 → 브라우저 권한 요청 → 승인

**검증 포인트**:
- 권한 상태별 UI 분기 (granted/denied/default)
- 거부 후 재요청 안내 메시지
- 권한 상태 localStorage 저장

---

### 13. 콜가이드 푸시 알림 (10분 후 공연!)

**파일**: `src/lib/call-guide-notification.ts`

**테스트 방법**:
1. 타임테이블에 콜가이드가 있는 슬롯 추가
2. Dev 메뉴에서 해당 슬롯 **10분 전**으로 시간 설정
3. **예상 결과**: 푸시 알림 "🎤 [곡명] 콜가이드를 확인하세요!"
4. 알림 클릭 → `/call-guide/{songId}` 이동

**검증 포인트**:
- 콜가이드 연결된 슬롯만 알림
- 푸시 알림 본문에 곡 정보 포함
- 딥링크로 콜가이드 페이지 직접 이동

---

## P2 - 콜가이드 고도화

### 14. 콜가이드 버전 히스토리 UI

**파일**: `src/components/call-guide/CallGuideHistory.tsx`

**테스트 방법**:
1. `/call-guide/{songId}` 접속 (기존 콜가이드)
2. "히스토리" 또는 "버전 기록" 버튼 클릭
3. **예상 결과**: 버전 목록 표시
   - v1, v2, v3... 시간순
   - 각 버전 편집자, 편집 시간, 변경 사유
4. 특정 버전 클릭 → 해당 버전 내용 미리보기
5. "비교" 버튼 → 두 버전 diff 표시

**검증 포인트**:
- `CallGuideVersionDiff` 컴포넌트로 변경 사항 하이라이트
- 추가된 항목: 초록색 배경
- 삭제된 항목: 빨간색 배경
- 수정된 항목: 노란색 배경

---

### 15. 콜가이드 수정 제안 (Suggest Edit)

**파일**: `src/components/call-guide/CallGuideSuggestion.tsx`

**테스트 방법**:
1. `/call-guide/{songId}` 접속
2. "수정 제안" 버튼 클릭
3. 제안 폼에서 수정 내용 입력:
   - 특정 타임스탬프 수정
   - 콜 텍스트 변경
   - 새 항목 추가 제안
4. "제안 제출" 클릭
5. **예상 결과**: 제안 목록에 추가됨

**편집자 측 테스트**:
1. 콜가이드 편집 권한 있는 사용자로 전환
2. "제안 검토" 탭 확인
3. 제안 승인/거절/수정 후 병합

**검증 포인트**:
- `SuggestionForm`: 제안 작성 UI
- `SuggestionCard`: 제안 목록 표시
- 승인 시 자동으로 새 버전 생성

---

### 16. 콜가이드 신고/롤백 기능

**파일**:
- `src/components/call-guide/CallGuideReport.tsx`
- `src/lib/call-guide-context.tsx`

**신고 테스트**:
1. `/call-guide/{songId}` 접속
2. 콜가이드 또는 개별 엔트리의 "신고" 버튼 클릭
3. `CallGuideReportModal` 표시 확인
4. 신고 사유 선택 (스팸/욕설/기타) + 상세 설명 입력
5. "신고하기" 클릭
6. **예상 결과**: 신고 접수 완료

**롤백 테스트**:
1. 버전 히스토리에서 이전 버전 선택
2. "이 버전으로 롤백" 버튼 클릭
3. `RollbackConfirmModal` 표시 확인
4. 롤백 확인 → 실행
5. **예상 결과**:
   - 콜가이드가 선택한 버전으로 복원
   - `RollbackSuccessToast` 표시
   - 새 버전으로 기록됨 (롤백도 버전 히스토리에 포함)

**숨김 테스트**:
1. 동일 콜가이드를 3회 이상 신고
2. **예상 결과**: `ReportedCallGuideBanner` 표시
   - "이 콜가이드는 검토 중입니다"
   - "그래도 보기" 버튼

**검증 포인트**:
- `isCallGuideHidden(callGuideId)` 확인
- 신고 횟수 `getReportCount()` 정확성
- 롤백 후 버전 번호 증가

---

## P2 - 리더보드 고도화

### 17. 윌슨 스코어 적용

**파일**: `src/lib/leaderboard-context.tsx`

**테스트 방법**:
1. `/leaderboard` 접속
2. 두 사용자 비교:
   - A: 도움됨 100개, 총 반응 100개 (100%)
   - B: 도움됨 10개, 총 반응 10개 (100%)
3. **예상 결과**: A가 B보다 높은 순위
   - 동일 비율이라도 샘플 수가 많을수록 신뢰도 높음

**검증 포인트**:
- `calculateWilsonScore(positive, total)` 함수
- 95% 신뢰구간 하한값 사용
- 샘플 수가 적은 경우 보수적 점수 부여

---

### 18. 최근성 가중치 (decay_factor)

**파일**: `src/lib/leaderboard-context.tsx`

**테스트 방법**:
1. `/leaderboard` 접속
2. 오래된 활동만 있는 사용자 vs 최근 활동 있는 사용자 비교
3. **예상 결과**: 최근 활동 사용자가 더 높은 점수

**검증 포인트**:
- `DECAY_HALF_LIFE_DAYS = 30` (30일 반감기)
- 30일 지난 활동은 50% 가치
- 60일 지난 활동은 25% 가치
- `applyDecay(score, date)` 함수 확인

---

### 19. 단기 대량 활동 감지 (어뷰징 방지)

**파일**: `src/lib/trust-context.tsx`

**테스트 방법**:
1. Dev 메뉴에서 특정 사용자로 설정
2. 1분 내에 10개 이상의 글/댓글/도움됨 연속 생성
3. **예상 결과**:
   - 경고 메시지 표시
   - 추가 활동 일시 제한
   - 신뢰도 점수 감소

**검증 포인트**:
- `BURST_THRESHOLD = 10` (1분 내 10개 이상)
- `BURST_WINDOW_MS = 60000` (1분)
- `detectBurstActivity(userId)` 함수
- 감지 시 `trust_score` 감소

---

## P3 - 기타

### 20. 슬롯 리뷰/영상 연결

**파일**:
- `src/lib/slot-content-context.tsx`
- `src/components/timetable/SlotContentSection.tsx`

**테스트 방법**:
1. `/myfes` → 타임테이블에서 특정 슬롯 클릭
2. 슬롯 상세에서 "리뷰/영상" 섹션 확인
3. "콘텐츠 추가" 버튼 클릭
4. 타입 선택:
   - **리뷰**: 텍스트 후기 작성
   - **하이라이트**: YouTube URL 입력
   - **직캠**: YouTube URL 입력
5. **예상 결과**: 슬롯에 콘텐츠 연결됨

**YouTube 연동 테스트**:
1. YouTube URL 입력 (예: `https://youtube.com/watch?v=xxx`)
2. **예상 결과**:
   - 썸네일 자동 추출
   - 영상 제목 표시 (가능한 경우)
   - 클릭 시 YouTube로 이동

**도움됨 테스트**:
1. 연결된 콘텐츠의 "도움됨" 버튼 클릭
2. **예상 결과**: 카운트 증가, 본인 콘텐츠는 불가

**검증 포인트**:
- `SlotReviewType`: "review" | "highlight" | "fancam"
- `extractYouTubeId()` 함수로 영상 ID 추출
- 썸네일 URL: `https://img.youtube.com/vi/{id}/mqdefault.jpg`

---

### 21. FOMO 루프 (친구 다녀온 행사 하이라이트)

**파일**: `src/components/social/FriendsHighlightCarousel.tsx`

**테스트 방법**:

**1. 캐러셀 테스트**:
1. Dev 메뉴에서 `user1`로 설정
2. `user1`이 다른 사용자(`user2`, `user3`)를 팔로우 중인지 확인
3. 팔로잉 사용자들이 "다녀옴" 또는 "리뷰" 활동이 있는지 확인
4. 홈페이지 또는 해당 섹션에서 `FriendsHighlightCarousel` 확인
5. **예상 결과**:
   - "친구들이 다녀온 행사" 캐러셀 표시
   - 포스터 이미지 + 친구 정보 오버레이
   - 좌우 스와이프/버튼으로 탐색
   - 페이지 인디케이터 (1/5 등)

**2. CTA 버튼 테스트**:
1. 캐러셀에서 특정 행사 카드 확인
2. "찜하기" 버튼 클릭 → 찜 목록에 추가
3. "다녀옴" 버튼 클릭 → 다녀옴 목록에 추가
4. 외부 링크 버튼 클릭 → 행사 상세 페이지 이동
5. **예상 결과**: 찜/다녀옴 처리 후 해당 카드 캐러셀에서 제외

**3. 미니 위젯 테스트**:
1. `FriendActivityMini` 컴포넌트가 배치된 위치 확인
2. **예상 결과**:
   - 최근 친구 활동 3개 표시
   - 아바타 + 닉네임 + 활동 내용
   - "모두 보기" 링크 → `/profile/activity`

**검증 포인트**:
- 팔로잉 중인 사용자의 활동만 표시
- `attended` 또는 `review` 타입만 필터링
- 이미 찜/다녀옴한 행사는 제외
- `eventId`와 `eventTitle`이 있는 활동만 표시

---

## 공통 테스트 환경 설정

### Dev 메뉴 사용법

```
1. 화면 우하단 보라색 🛠️ 버튼 클릭
2. 시나리오 A~F 전환으로 다양한 행사 상태 테스트
3. 시간 조정으로 LIVE/RECAP 모드 전환
4. 사용자 전환으로 권한/상태별 테스트
```

### 시나리오별 URL

| 시나리오 | URL | 설명 |
|----------|-----|------|
| A | `/event/55948` | 기본 (단일일정, 예정) |
| B | `/event/e2` | 다일 페스티벌 (LIVE) |
| C | `/event/24016943` | 지난 행사 (RECAP) |

### 사용자 계정

| ID | 역할 | 특징 |
|----|------|------|
| user1 | 일반 사용자 | 기본 테스트용 |
| user2 | crew1 크루장 | 크루 관리 테스트 |
| user3 | crew2 크루장 | 다른 크루 테스트 |

---

## 빌드 및 검증

```bash
# 타입 체크 포함 빌드
npm run build

# E2E 테스트 실행
npm run test:e2e

# 개발 서버
npm run dev
```

---

## 변경된 주요 파일 목록

### Context 파일
- `src/lib/helpful-context.tsx` - 자기 글 도움됨 차단
- `src/lib/user-profile-context.tsx` - canViewContent 완성
- `src/lib/leaderboard-context.tsx` - 윌슨 스코어, 최근성 가중치, 신고 차감
- `src/lib/post-context.tsx` - 신고 누적 숨김
- `src/lib/notification-context.tsx` - Quiet Hours, dedupe_key
- `src/lib/my-timetable-context.tsx` - 슬롯 알림
- `src/lib/call-guide-context.tsx` - 신고/롤백
- `src/lib/slot-content-context.tsx` - 슬롯 콘텐츠 (NEW)
- `src/lib/trust-context.tsx` - 어뷰징 감지

### 컴포넌트 파일
- `src/components/posts/PostCard.tsx` - 숨김 글 UI
- `src/components/call-guide/CallGuideHistory.tsx` - 버전 히스토리 (NEW)
- `src/components/call-guide/CallGuideSuggestion.tsx` - 수정 제안 (NEW)
- `src/components/call-guide/CallGuideReport.tsx` - 신고/롤백 UI (NEW)
- `src/components/timetable/SlotContentSection.tsx` - 슬롯 콘텐츠 (NEW)
- `src/components/social/FriendsHighlightCarousel.tsx` - FOMO 루프 (NEW)
- `src/components/notifications/NotificationPermission.tsx` - 권한 요청 UI (NEW)

### 타입 파일
- `src/types/event.ts` - SlotContent, SlotReviewType 추가
- `src/types/report.ts` - call_guide, call_guide_entry 추가

### PWA 파일
- `public/sw.js` - Service Worker
- `public/manifest.json` - PWA 매니페스트
