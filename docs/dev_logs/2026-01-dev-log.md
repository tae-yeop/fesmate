# 2026-01 개발 로그

## 잔여 작업 현황 (2026-01-06 코드 기준 상세 검토)

### 요약

| 카테고리 | 작업 수 | 상태 |
|----------|--------|------|
| Supabase Context 연동 | 11개 | ⏳ 쿼리 있음, Context 전환 필요 |
| 크루 오버레이 P2-P3 | 4개 | ❌ 미착수 |
| 사용자 이벤트 등록 | 4개 | ⏳ Context만 구현 |
| 크롤링 파이프라인 | 4개 | ⏳ 구조 완료, 동작 미검증 |
| Admin 도구 | 7개 페이지 | ⏳ 대시보드만 완료 |
| 푸시 알림 | 4개 | ❌ 미구현 |
| 리더보드 고도화 | 3개 | ❌ 미구현 |
| 티켓북 확장 | 3개 | ⏳ 쿼리만 완료 |

---

## 1. Supabase Context 연동 (11개)

### 이미 연동 완료 (7개)
- ✅ `wishlist-context.tsx` → `queries/user-events.ts`
- ✅ `helpful-context.tsx` → `queries/reactions.ts` (부분)
- ✅ `notification-context.tsx` → `queries/notifications.ts` (부분)
- ✅ `ticketbook-context.tsx` → `queries/tickets.ts`
- ✅ `user-profile-context.tsx` → `queries/users.ts`
- ✅ `companion-context.tsx` → `queries/companions.ts`
- ✅ `join-context.tsx` → `queries/participation.ts`

### 연동 필요 (11개)
- [ ] `post-context.tsx` → `queries/posts.ts` 활용 (글 CRUD)
- [ ] `comment-context.tsx` → `queries/comments.ts` 활용
- [ ] `follow-context.tsx` → `queries/follows.ts` 활용
- [ ] `block-context.tsx` → `queries/blocks.ts` 활용
- [ ] `crew-context.tsx` → `queries/crews.ts` 완성 (통계/추천 미구현)
- [ ] `badge-context.tsx` → `queries/badges.ts` 자동 획득 로직
- [ ] `leaderboard-context.tsx` → `queries/leaderboard.ts` 완성
- [ ] `call-guide-context.tsx` → `queries/call-guides.ts` 신고/롤백 연동
- [ ] `my-timetable-context.tsx` → Supabase 저장 + Realtime 동기화
- [ ] `participation-context.tsx` → 알림 트리거 연동
- [ ] `event-registration-context.tsx` → Supabase 저장 (TODO 주석 있음)

---

## 2. 크루 오버레이 P2-P3 (4개)

`crew-context.tsx` Core 기능은 완료 (1,184줄), 고급 기능 미착수:

- [ ] **히트맵 뷰** - 일별/스테이지별 참여 인원 시각화
  - 필요 컴포넌트: `/crew/[id]/heatmap.tsx`
  - 데이터: 시간대별 멤버 참여도 계산
  - 셀 클릭 시 상세 모달

- [ ] **소그룹 기능** - 크루 내 팀 분할
  - `crew-subgroup-context.tsx` Supabase 연동 필요
  - Supabase 테이블 추가 필요 (`crew_subgroups`)

- [ ] **통계/차트 뷰** - 평균 슬롯, 인기 시간대, 스테이지 선호도
  - 소그룹별 통계 집계
  - TOP 5 슬롯 표시

- [ ] **취향 유사 멤버 추천** - Jaccard 유사도 기반
  - 공통 슬롯 비율 계산 알고리즘
  - 상위 5명 추천 UI

---

## 3. 사용자 이벤트 등록 (4개)

`event-registration-context.tsx` (397줄) 현재 상태:
- ✅ 행사 등록/수정/삭제 (Mock + localStorage)
- ✅ 유사 행사 검색 (중복 감지)

미구현:
- [ ] **Supabase 저장** - 라인 245-246, 311-312, 342-343에 TODO 주석 있음
- [ ] **타임테이블 편집 UI** - 슬롯 추가/수정/삭제 모달
- [ ] **셋리스트 에디터** - 곡 순서 드래그 앤 드롭, 콜가이드 연동
- [ ] **Admin 승인 플로우** - 사용자 등록 행사 검토/승인/거절

---

## 4. 크롤링 파이프라인 (4개)

`src/lib/crawl/` 구조 완료 (11개 파일), 동작 미검증:

- [ ] **Headless 크롤링** - YES24 CSR 대응 (Playwright 필요)
- [ ] **Cron 스케줄 설정** - vercel.json 또는 node-cron
- [ ] **크롤링 API 라우트** - `/api/crawl/schedule/route.ts` (미존재)
- [ ] **E2E 테스트** - 실제 사이트 크롤링 검증

---

## 5. Admin 도구 (7개 페이지)

### 완료
- ✅ `/admin` - 대시보드 (95%)
- ✅ `/admin/audit` - 감사 로그 (70%)
- ✅ `/admin/layout.tsx` - 사이드바, 권한 검사

### 미완료

#### `/admin/reports` - 신고 관리 (50%)
- [ ] `getReports()` 쿼리 호출
- [ ] 신고 상태 필터 (pending/reviewing/approved/rejected)
- [ ] 신고 상세 모달
- [ ] 상태 변경 액션 (approve/reject/archive)
- [ ] 신고 대상별 필터 (user/post/comment/call_guide)

#### `/admin/events` - 행사 관리 (30%)
- [ ] `getAdminEvents()` 쿼리 호출
- [ ] 행사 검색/필터
- [ ] 행사 상세 수정 (상태, 날짜, override_mode)
- [ ] 행사 삭제
- [ ] 배치 상태 변경

#### `/admin/users` - 사용자 관리 (30%)
- [ ] `getAdminUsers()` 쿼리 호출
- [ ] 사용자 검색/필터
- [ ] 정지/해제 기능 (`sanction-context.tsx` 연동)
- [ ] 사용자 상세 정보 모달
- [ ] 활동 이력 조회

#### `/admin/content` - 콘텐츠 관리 (20%)
- [ ] 글/댓글 목록 조회
- [ ] 삭제/숨김 기능
- [ ] 스팸/악성 콘텐츠 필터링
- [ ] 배치 삭제

#### `/admin/crawl` - 크롤링 관리 (40%)
- [ ] 실시간 크롤링 상태 표시
- [ ] 에러 로그 조회
- [ ] 수동 크롤링 트리거

#### `/admin/crawl/suggestions` - 크롤링 제안 승인 (10%)
- [ ] `getCrawlSuggestions()` 쿼리
- [ ] 제안된 행사 목록
- [ ] 중복 감지 및 병합
- [ ] 일괄 승인/거절
- [ ] 수정 후 승인

---

## 6. 푸시 알림 (4개)

현재 상태: `push-context.tsx` 스텁만 존재

- [ ] **Service Worker** - `/public/sw.js` 생성
  - 알림 수신 핸들러
  - 클릭 시 딥링크 이동

- [ ] **Web App Manifest** - `/public/manifest.json` 생성
  - name, icons, theme_color, display

- [ ] **푸시 구독 로직** - `push-context.tsx` 완성
  - VAPID 키 생성
  - `subscribeToPush()` 함수
  - Supabase에 구독 정보 저장

- [ ] **알림 권한 요청 UI**
  - 권한 요청 모달/배너
  - 설정 페이지에서 on/off

---

## 7. 리더보드 고도화 (3개)

`leaderboard-context.tsx` (354줄) 현재 상태:
- ✅ 기본 점수 계산 (도움됨 10점, 제보 15점, 댓글 3점 등)
- ✅ 페널티 시스템 (신고 -50/-20점)
- ✅ 기간별 필터 (all_time/monthly/weekly)

미구현:
- [ ] **Wilson Score 계산** - 신뢰 구간 기반 점수
  ```typescript
  // (positive + z²/2n) / (1 + z²/n)
  function calculateWilsonScore(positive: number, total: number, z?: number): number
  ```

- [ ] **Decay Factor** - 시간 경과에 따른 점수 감소
  - 최근 활동에 가중치 부여
  - 30일 이상 된 활동 점수 감소

- [ ] **어뷰징 패턴 감지** - 단기 대량 활동 감지
  - 1시간 내 10개 이상 활동 경고
  - 자기 글/댓글 반응 차단

---

## 8. 티켓북 확장 (3개)

`ticketbook-context.tsx` (568줄) 현재 상태:
- ✅ 티켓 CRUD (Supabase 연동)
- ✅ 정렬 기능
- ✅ 앞면/뒷면 이미지

미구현:
- [ ] **티켓 공유 UI** - `queries/ticket-shares.ts` 쿼리 있음
  - 공유 링크 생성 모달
  - `/share/tickets/[shareId]` 공개 페이지
  - 내가 공유한 티켓 목록

- [ ] **연간 리포트 UI 연결** - 컴포넌트는 있으나 미연결
  - `/myfes` 또는 `/profile`에서 진입점 추가
  - 6가지 카드 타입 렌더링
  - 공유 이미지 생성

- [ ] **AI 마스킹** - 개인정보 자동 가림 (P3)

---

## 9. 기타 보류 항목 (3개)

사업자 인증 필요:
- ⏸️ 카카오 OAuth (KOE205 에러)
- ⏸️ 네이버 OAuth
- ⏸️ 카카오톡 공유

---

## 우선순위별 작업 목록

### P0 - 즉시 필요 (6개)

1. [ ] `post-context.tsx` Supabase 연동
2. [ ] `event-registration-context.tsx` Supabase 저장
3. [ ] `/admin/reports` 신고 관리 페이지 완성
4. [ ] `/admin/crawl/suggestions` 크롤링 제안 승인
5. [ ] `comment-context.tsx` Supabase 연동
6. [ ] 크롤링 E2E 테스트

### P1 - 1주일 내 (8개)

7. [ ] `/admin/events` 행사 관리 페이지
8. [ ] `/admin/users` 사용자 관리 페이지
9. [ ] 크루 히트맵 뷰
10. [ ] 크루 취향 유사 멤버 추천
11. [ ] `follow-context.tsx` Supabase 연동
12. [ ] `block-context.tsx` Supabase 연동
13. [ ] 콜가이드 신고 Supabase 저장
14. [ ] 배지 자동 획득 Supabase 기반 변경

### P2 - 2주일 내 (7개)

15. [ ] Wilson Score 구현
16. [ ] Decay Factor 구현
17. [ ] 어뷰징 패턴 감지
18. [ ] `my-timetable-context.tsx` Supabase 연동
19. [ ] 티켓 공유 UI
20. [ ] 연간 리포트 UI 연결
21. [ ] `/admin/content` 콘텐츠 관리

### P3 - 3주일 이상 (8개)

22. [ ] Service Worker 구현
23. [ ] Web App Manifest
24. [ ] 푸시 구독 로직
25. [ ] 알림 권한 요청 UI
26. [ ] 크루 소그룹 기능
27. [ ] 크루 통계/차트 뷰
28. [ ] 타임테이블 편집 UI
29. [ ] 셋리스트 에디터

---

## 코드 vs 문서 차이점 정리 (2026-01-06)

### ✅ 실제 구현 확인됨

| 항목 | 파일 | 확인 내용 |
|------|------|----------|
| Quiet Hours | `notification-context.tsx` | 22:00-08:00 + urgent 타입 예외 |
| 중복 묶음 (dedupe_key) | `notification-context.tsx` | 구현됨 |
| 자기 글 도움됨 차단 | `helpful-context.tsx` | postUserId 체크 |
| 콜가이드 버전 히스토리 | `call-guide-context.tsx` | 983줄, 롤백 포함 |
| 콜가이드 신고/자동 숨김 | `call-guide-context.tsx` | HIDE_THRESHOLD=3 |
| 신고 시 점수 차감 | `leaderboard-context.tsx` | -50/-20점 페널티 |
| 크루 Core 기능 | `crew-context.tsx` | 1,184줄, 가입/공지/통계 |
| 티켓북 Core | `ticketbook-context.tsx` | 568줄, CRUD 완료 |
| 슬롯 10분 전 알림 | `notification-context.tsx` | slot_start_reminder |

### ❌ 문서에 완료라고 했지만 미구현

| 항목 | 문서 상태 | 실제 상태 |
|------|----------|----------|
| PWA Service Worker | ✅ 완료 | ❌ 파일 없음 |
| Web Push API 통합 | ✅ 완료 | ❌ 미구현 |
| 윌슨 스코어 | ✅ 완료 | ❌ 단순 합계만 |
| Decay Factor | ✅ 완료 | ❌ 임의 배수만 |
| 어뷰징 감지 | ✅ 완료 | ⚠️ trust-context 스텁만 |
| 티켓 공유 UI | ✅ 완료 | ⏳ 쿼리만 |
| 연간 리포트 UI | ✅ 완료 | ⏳ 컴포넌트만, 미연결 |

---

## 2026-01-04: 데이터 모드 분리 (Mock/Supabase)

### 문제
- Mock 데이터(문자열 ID)와 Supabase(UUID)가 혼용되어 데이터 불일치 발생
- 글 작성 후 새로고침 시 사라지는 문제
- mockUserId, dataMode가 새로고침 시 리셋되는 문제

### 근본 원인
1. DevContext의 상태가 localStorage에 저장되지 않음
2. PostContext가 DevContext hydration 전에 데이터를 로드함 (초기값 사용)
3. 새로고침 시 mockUserId=null, dataMode="mock"으로 리셋

### 해결
- DevContext에 `isHydrated` 상태 추가 (localStorage 로드 완료 표시)
- DevContext에서 `mockUserId`, `dataMode`를 localStorage에 저장/복원
- PostContext에서 `isHydrated`가 true일 때만 데이터 로드 (hydration 대기)

### 수정된 파일

| 파일 | 변경 내용 |
|------|----------|
| `src/lib/dev-context.tsx` | `dataMode`, `isHydrated` 추가, localStorage 저장/복원 |
| `src/components/dev/DevPanel.tsx` | 데이터 모드 토글 UI |
| `src/lib/post-context.tsx` | `isHydrated` 체크 추가, hydration 대기 로직 |

---

## 2026-01-03: 기타 기능 구현

> 상세 테스트 가이드: [2026-01-03-기타기능-테스트가이드.md](./2026-01-03-기타기능-테스트가이드.md)

### 완료된 기능

#### P0 - 즉시 구현 (5개)
1. ✅ 자기 글 도움됨 차단
2. ✅ canViewContent 완성 (friends/crew 레벨)
3. ✅ 리더보드 신고 시 점수 차감
4. ✅ 신고 누적 시 글 자동 숨김
5. ✅ 숨김 글 UI (검토 중 표시 + 보기/차단 CTA)

#### P1 - 알림 시스템 고도화 (4개)
6. ✅ Quiet Hours (22:00-08:00)
7. ✅ 중복 묶음 (dedupe_key)
8. ✅ 콜가이드 LIVE 연동 (HubTab)
9. ✅ 슬롯 시작 10분 전 알림

#### P2 - 콜가이드 고도화 (3개)
10. ✅ 버전 히스토리 UI
11. ✅ 수정 제안 (Suggest Edit)
12. ✅ 신고/롤백 기능

### 보류 / 미구현
- ❌ PWA Service Worker 설정
- ❌ Web Push API 통합
- ❌ 윌슨 스코어 적용
- ❌ Decay Factor
- ⏸️ 카카오 OAuth (사업자 인증 필요)
- ⏸️ 네이버 OAuth (사업자 인증 필요)
- ⏸️ 카카오톡 공유 (사업자 인증 필요)

### 신규 파일

| 파일 | 설명 |
|------|------|
| `src/components/call-guide/CallGuideHistory.tsx` | 버전 히스토리 + Diff UI |
| `src/components/call-guide/CallGuideSuggestion.tsx` | 수정 제안 폼/카드 |
| `src/components/call-guide/CallGuideReport.tsx` | 신고/롤백 모달 |
| `src/components/timetable/SlotContentSection.tsx` | 슬롯 리뷰/영상 연결 UI |
| `src/components/social/FriendsHighlightCarousel.tsx` | FOMO 루프 캐러셀 |
| `src/lib/slot-content-context.tsx` | 슬롯 콘텐츠 Context |

---

## 이전 기록

### 티켓 공유
- `/myfes` → 티켓북 탭 → 티켓 클릭 → 공유 버튼 클릭
- 다운로드, URL 복사, 카카오톡, 인스타 스토리 옵션

### 연간 리포트 (TODO: UI 연결 필요)
- 6가지 카드 타입: 총 관람, 장르, 아티스트, 월별, 동행자, 공연장
- Spotify Wrapped 스타일 디자인

### 공유 갤러리 (TODO: DB 마이그레이션 적용 후)
- `/share/tickets/[shareId]` - 공개 URL 갤러리
- OG 메타 태그로 SNS 미리보기 지원
